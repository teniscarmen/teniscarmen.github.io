<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Migraci√≥n Firestore A ‚ûú B</title>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <h2>Migraci√≥n Firestore A ‚ûú B <span id="version" style="font-size: 0.8em; color: gray;"></span></h2>
  <button id="migrarBtn">Iniciar migraci√≥n</button>
  <pre id="log" style="margin-top:20px; background:#f4f4f4; padding:10px; max-height: 500px; overflow-y: auto;"></pre>

  <script type="module">
    // üî¢ Versi√≥n del migrador
    const MIGRADOR_VERSION = "v1.0.1";
    document.getElementById("version").textContent = `(${MIGRADOR_VERSION})`;
    document.title = `Migraci√≥n Firestore A ‚ûú B ${MIGRADOR_VERSION}`;

    // ‚úÖ IMPORTS CORRECTOS usando .mjs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.mjs";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      setDoc,
      listCollections,
    } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.mjs";

    const log = document.getElementById("log");

    // Configuraci√≥n Proyecto A (cuenta personal)
    const configA = {
      apiKey: "AIzaSyCe_HbdWlApCldi2Rk8uituDIwr_RcjAqE",
      authDomain: "tenis-1baf2.firebaseapp.com",
      projectId: "tenis-1baf2",
      storageBucket: "tenis-1baf2.firebasestorage.app",
      messagingSenderId: "1063958178043",
      appId: "1:1063958178043:web:01276f257cc083bac1285e",
      measurementId: "G-XXEEL6LMND"
    };

    // Configuraci√≥n Proyecto B (cuenta propia)
    const configB = {
      apiKey: "AIzaSyABlVZR55dbT8KfuEVbnxhquwWP0VbLBy4",
      authDomain: "tenis-chidos-ags.firebaseapp.com",
      projectId: "tenis-chidos-ags",
      storageBucket: "tenis-chidos-ags.firebasestorage.app",
      messagingSenderId: "13324233273",
      appId: "1:13324233273:web:d7eb9f5a0e8ed0a4317be8"
    };

    // Inicializar ambas apps
    const appA = initializeApp(configA, "appA");
    const appB = initializeApp(configB, "appB");

    const dbA = getFirestore(appA);
    const dbB = getFirestore(appB);

    // Funci√≥n para imprimir l√≠neas en el log
    function logLinea(texto) {
      log.textContent += texto + "\n";
    }

    // Funci√≥n recursiva para migrar colecciones y subcolecciones
    async function migrarColeccion(path, refA, refB) {
      const snap = await getDocs(refA);
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        const docRefB = doc(refB, docSnap.id);
        await setDoc(docRefB, data);
        logLinea(`‚úî Migrado: ${path}/${docSnap.id}`);

        // Subcolecciones recursivas
        const subcols = await listCollections(docSnap.ref);
        for (const subcol of subcols) {
          const subcolName = subcol.id;
          const nuevaRuta = `${path}/${docSnap.id}/${subcolName}`;
          logLinea(`üìÅ Subcolecci√≥n: ${nuevaRuta}`);
          await migrarColeccion(
            nuevaRuta,
            collection(docSnap.ref, subcolName),
            collection(docRefB, subcolName)
          );
        }
      }
    }

    // Funci√≥n principal de migraci√≥n
    async function migrarDatos() {
      log.textContent = `üõ† Migrador Firestore ${MIGRADOR_VERSION} iniciado...\n`;

      try {
        const colecciones = await listCollections(dbA);

        for (const col of colecciones) {
          const colName = col.id;
          logLinea(`üìÅ Colecci√≥n ra√≠z: ${colName}`);
          await migrarColeccion(colName, collection(dbA, colName), collection(dbB, colName));
        }

        logLinea(`\n‚úÖ Migraci√≥n COMPLETA con √©xito. (${MIGRADOR_VERSION})`);
      } catch (error) {
        logLinea(`‚ùå Error: ${error.message}`);
      }
    }

    // Bot√≥n de acci√≥n
    document.getElementById("migrarBtn").addEventListener("click", migrarDatos);
  </script>
</body>
</html>
